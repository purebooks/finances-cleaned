<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Backend Test Interface</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f8f9fa; display: flex; justify-content: center; padding-top: 40px; }
        .container { width: 90%; max-width: 900px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 30px; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        input[type="file"], input[type="text"], button {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px;
        }
        input[type="text"] { margin-bottom: 10px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #status { text-align: center; padding: 12px; border-radius: 6px; margin-top: 20px; font-weight: 500; }
        .status-loading { background-color: #e9ecef; color: #495057; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .results { margin-top: 30px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
        th { background-color: #f2f2f2; font-weight: 600; }
        pre { background-color: #e9ecef; padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: "SF Mono", "Menlo", "Monaco", monospace; font-size: 13px; }
        .insights { background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .insights h3 { margin-top: 0; color: #495057; }
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .insight-item { background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; }
        .insight-label { font-weight: 600; color: #495057; font-size: 12px; }
        .insight-value { font-size: 16px; color: #333; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ironclad Backend Test Interface</h1>
    
    <div class="input-group">
        <label for="fileInput">1. Upload CSV or JSON File</label>
        <input type="file" id="fileInput" accept=".csv,.json">
    </div>

    <div class="input-group">
        <label for="intentInput">2. Enter Your Cleaning Intent (Magic Text Bar)</label>
        <input type="text" id="intentInput" placeholder="e.g., find duplicates and errors">
    </div>

    <button onclick="processFile()">3. Clean My Data</button>

    <div id="status"></div>

    <div class="results" id="results" style="display:none;">
        <h2>Processing Insights</h2>
        <div id="insights" class="insights"></div>
        
        <h2>Summary Report</h2>
        <pre id="summaryReport"></pre>
        
        <h2>Cleaned Data</h2>
        <div id="cleanedDataTable"></div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080/process";

    async function processFile() {
        const fileInput = document.getElementById('fileInput');
        const intentInput = document.getElementById('intentInput');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        if (fileInput.files.length === 0) {
            alert('Please select a file first.');
            return;
        }

        const file = fileInput.files[0];
        const userIntent = intentInput.value || "Standard cleaning";

        statusDiv.textContent = 'Processing...';
        statusDiv.className = 'status-loading';
        resultsDiv.style.display = 'none';

        try {
            const fileContent = await file.text();
            let data;
            if (file.name.endsWith('.csv')) {
                data = csvToJSON(fileContent);
            } else {
                data = JSON.parse(fileContent);
            }

            const payload = {
                user_intent: userIntent,
                data: data 
            };
            
            // Debug: Log what we're sending
            console.log('Sending payload:', JSON.stringify(payload, null, 2));
            console.log('Data length:', data.length);
            console.log('First record:', data[0]);
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || `HTTP error! Status: ${response.status}`);
            }
            
            const insights = result.insights || {};
            // --- ROBUSTNESS FIX ---
            // Safely access properties that might not exist in every response
            const processingTime = result.processing_time || insights.processing_time || 0;
            statusDiv.textContent = `Success! Processed in ${processingTime.toFixed(2)}s.`;
            statusDiv.className = 'status-success';
            resultsDiv.style.display = 'block';

            displayResults(result, processingTime);

        } catch (error) {
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.className = 'status-error';
            console.error('Processing failed:', error);
        }
    }

    function displayResults(result, processingTime) {
        // Display Insights
        const insightsDiv = document.getElementById('insights');
        const insights = result.insights || {};
        
        let insightsHTML = '<h3>Processing Results</h3><div class="insights-grid">';
        insightsHTML += `<div class="insight-item"><div class="insight-label">Processing Time</div><div class="insight-value">${(processingTime || 0).toFixed(2)}s</div></div>`;
        insightsHTML += `<div class="insight-item"><div class="insight-label">Rows Processed</div><div class="insight-value">${insights.rows_processed || 0}</div></div>`;
        insightsHTML += `<div class="insight-item"><div class="insight-label">AI Requests</div><div class="insight-value">${insights.ai_requests || 0}</div></div>`;
        insightsHTML += `<div class="insight-item"><div class="insight-label">AI Cost</div><div class="insight-value">$${(insights.ai_cost || 0).toFixed(4)}</div></div>`;
        
        if (insights.vendor_transformations && insights.vendor_transformations.length > 0) {
            insightsHTML += `<div class="insight-item" style="grid-column: 1 / -1;"><div class="insight-label">Vendor Transformations</div><div class="insight-value">${insights.vendor_transformations.length} changes</div></div>`;
        }
        
        insightsHTML += '</div>';
        insightsDiv.innerHTML = insightsHTML;

        // Display Summary Report
        const summaryReport = document.getElementById('summaryReport');
        summaryReport.textContent = JSON.stringify(result.summary_report, null, 2);

        // Display Cleaned Data Table
        const tableContainer = document.getElementById('cleanedDataTable');
        const data = result.cleaned_data;
        if (!data || data.length === 0) {
            tableContainer.innerHTML = "<p>No data returned.</p>";
            return;
        }
        
        const headers = Object.keys(data[0]);
        let table = '<table><thead><tr>';
        headers.forEach(h => table += `<th>${h}</th>`);
        table += '</tr></thead><tbody>';

        data.forEach(row => {
            table += '<tr>';
            headers.forEach(h => {
                let value = row[h];
                if (value === null || typeof value === 'undefined') {
                    value = ' ';
                } else if (typeof value === 'object') {
                    value = JSON.stringify(value);
                }
                table += `<td>${value}</td>`;
            });
            table += '</tr>';
        });

        table += '</tbody></table>';
        tableContainer.innerHTML = table;
    }

    function csvToJSON(csv) {
        const lines = csv.split('\n').filter(line => line.trim() !== '');
        const result = [];
        const headers = lines[0].split(',').map(h => h.trim());
        for (let i = 1; i < lines.length; i++) {
            const obj = {};
            const currentline = lines[i].split(',');
            for (let j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentline[j] ? currentline[j].trim() : '';
            }
            result.push(obj);
        }
        return result;
    }
</script>

</body>
</html>
