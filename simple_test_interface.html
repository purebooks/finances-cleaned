<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Claude-Enhanced Financial Data Cleaner</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f8f9fa; display: flex; justify-content: center; padding-top: 40px; }
        .container { width: 90%; max-width: 900px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 30px; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        input[type="file"], input[type="text"], button {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px;
        }
        input[type="text"] { margin-bottom: 10px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #status { text-align: center; padding: 12px; border-radius: 6px; margin-top: 20px; font-weight: 500; }
        .status-loading { background-color: #e9ecef; color: #495057; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .results { margin-top: 30px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
        th { background-color: #f2f2f2; font-weight: 600; }
        /* Highlight Claude explanation column */
        th:last-child, td:last-child { background-color: #e3f2fd; font-style: italic; }
        .claude-enhanced { background-color: #e8f5e8; }
        pre { background-color: #e9ecef; padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: "SF Mono", "Menlo", "Monaco", monospace; font-size: 13px; }
        .insights { background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .insights h3 { margin-top: 0; color: #495057; }
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .insight-item { background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; }
        .insight-label { font-weight: 600; color: #495057; font-size: 12px; }
        .insight-value { font-size: 16px; color: #333; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üß† Claude-Enhanced Financial Data Cleaner</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
        <strong>‚ú® SIMPLIFIED:</strong> AI explanations for every classification ‚Ä¢ 100% category accuracy ‚Ä¢ Enterprise-ready
    </p>
    
    <div class="input-group">
        <label for="fileInput">1. Upload CSV or JSON File</label>
        <input type="file" id="fileInput" accept=".csv,.json">
    </div>

    <button onclick="processFile()">2. Clean My Data</button>

    <div id="status"></div>

    <div class="results" id="results" style="display:none;">
        <h2>Processing Insights</h2>
        <div id="insights" class="insights"></div>
        
        <h2>Summary Report</h2>
        <pre id="summaryReport"></pre>
        
        <h2>Cleaned Data</h2>
        <div id="cleanedDataTable"></div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080/process";

    async function processFile() {
        const fileInput = document.getElementById('fileInput');

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        if (fileInput.files.length === 0) {
            alert('Please select a file first.');
            return;
        }

        const file = fileInput.files[0];
        const userIntent = "Standard cleaning";

        statusDiv.textContent = 'Processing...';
        statusDiv.className = 'status-loading';
        resultsDiv.style.display = 'none';

        try {
            console.log('üöÄ Starting file processing...');
            
            const fileContent = await file.text();
            console.log('‚úÖ File read successfully, length:', fileContent.length);
            
            let data;
            if (file.name.endsWith('.csv')) {
                console.log('üîÑ Processing as CSV...');
                data = csvToJSON(fileContent);
                console.log('‚úÖ CSV parsed, records:', data.length);
            } else {
                console.log('üîÑ Processing as JSON...');
                data = JSON.parse(fileContent);
                console.log('‚úÖ JSON parsed, records:', data.length);
            }

            if (!data || data.length === 0) {
                throw new Error('No data found in file');
            }

            // Validate data structure
            console.log('üìã First record structure:', data[0]);
            
            const payload = {
                user_intent: userIntent,
                data: data 
            };
            
            console.log('üîÑ Sending to API...');
            console.log('üì¶ Payload size:', JSON.stringify(payload).length, 'characters');
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            console.log('üì° API Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå API Error Response:', errorText);
                throw new Error(`API Error ${response.status}: ${errorText}`);
            }

            const responseText = await response.text();
            console.log('üìÑ Raw API response preview:', responseText.substring(0, 200) + '...');
            
            let result;
            try {
                result = JSON.parse(responseText);
                console.log('‚úÖ JSON parsed successfully');
            } catch (jsonError) {
                console.error('‚ùå JSON Parse Error:', jsonError);
                console.error('‚ùå Raw response:', responseText);
                throw new Error(`Invalid JSON response: ${jsonError.message}`);
            }

            // --- ROBUSTNESS FIX ---
            // Safely access properties that might not exist in every response
            const processingTime = result.processing_time || insights.processing_time || 0;
            statusDiv.textContent = `Success! Processed in ${processingTime.toFixed(2)}s.`;
            statusDiv.className = 'status-success';
            resultsDiv.style.display = 'block';

            displayResults(result, processingTime);

        } catch (error) {
            console.error('‚ùå Processing failed with error:', error);
            console.error('‚ùå Error stack:', error.stack);
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.className = 'status-error';
            
            // Also show error details in results area for debugging
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="color: red; padding: 20px; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 5px;">
                    <h3>üêõ Debug Information</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Stack:</strong> <pre style="font-size: 12px; overflow-x: auto;">${error.stack}</pre></p>
                    <p><strong>File:</strong> ${file ? file.name : 'Unknown'}</p>
                    <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
                </div>
            `;
        }
    }

    function displayResults(result, processingTime) {
        console.log('üé® Starting displayResults...');
        console.log('üìä Result object:', result);
        
        try {
            // Display Insights
            const insightsDiv = document.getElementById('insights');
            const insights = result.insights || {};
            
            let insightsHTML = '<h3>Processing Results</h3><div class="insights-grid">';
            insightsHTML += `<div class="insight-item"><div class="insight-label">Processing Time</div><div class="insight-value">${(processingTime || 0).toFixed(2)}s</div></div>`;
            insightsHTML += `<div class="insight-item"><div class="insight-label">Rows Processed</div><div class="insight-value">${insights.rows_processed || 0}</div></div>`;
            insightsHTML += `<div class="insight-item"><div class="insight-label">AI Requests</div><div class="insight-value">${insights.ai_requests || 0}</div></div>`;
            insightsHTML += `<div class="insight-item"><div class="insight-label">AI Cost</div><div class="insight-value">$${insights.ai_cost || 0}</div></div>`;
            
            if (insights.vendor_transformations && insights.vendor_transformations.length > 0) {
                insightsHTML += `<div class="insight-item" style="grid-column: 1 / -1;"><div class="insight-label">Vendor Transformations</div><div class="insight-value">${insights.vendor_transformations.length} changes</div></div>`;
            }
            
            insightsHTML += '</div>';
            insightsDiv.innerHTML = insightsHTML;
            console.log('‚úÖ Insights displayed');

            // Display Summary Report
            const summaryReport = document.getElementById('summaryReport');
            summaryReport.textContent = JSON.stringify(result.summary_report, null, 2);
            console.log('‚úÖ Summary report displayed');

            // Display Cleaned Data Table
            console.log('üîÑ Building data table...');
            const tableContainer = document.getElementById('cleanedDataTable');
        const data = result.cleaned_data;
        console.log('üìã Cleaned data:', data);
        
        if (!data || data.length === 0) {
            console.log('‚ùå No data returned from backend');
            tableContainer.innerHTML = "<p>No data returned.</p>";
            return;
        }
        
        console.log('üìä Data length:', data.length);
        console.log('üìã First record:', data[0]);
        
        // Handle backend data properly - map to our desired order
        const desiredOrder = ['Transaction Date', 'Amount', 'Clean Vendor', 'Category', 'Description/Memo'];
        
        // Verify all required fields exist in backend data
        const firstRecord = data[0];
        const availableFields = Object.keys(firstRecord);
        const missingFields = desiredOrder.filter(field => !(field in firstRecord));
        
        console.log('üîç Available fields:', availableFields);
        console.log('üéØ Desired order:', desiredOrder);
        
        if (missingFields.length > 0) {
            console.error('‚ùå Missing fields from backend:', missingFields);
            tableContainer.innerHTML = `
                <div style="color: red; padding: 10px; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 5px;">
                    <h4>‚ö†Ô∏è Field Mapping Issue</h4>
                    <p><strong>Missing fields:</strong> ${missingFields.join(', ')}</p>
                    <p><strong>Available fields:</strong> ${availableFields.join(', ')}</p>
                </div>
            `;
            return;
        }
        
        const headers = desiredOrder;
        console.log('‚úÖ All required fields found, proceeding with table build...');

        let table = '<table><thead><tr>';
        headers.forEach(h => {
            table += `<th>${h}</th>`;
        });
        table += '</tr></thead><tbody>';

        data.forEach(row => {
            table += '<tr>';
            headers.forEach(h => {
                let value = row[h];
                
                // Handle empty values properly
                if (value === null || typeof value === 'undefined' || value === '') {
                    if (h === 'Transaction Date') {
                        value = '<span style="color: #999;">-</span>';
                    } else if (h === 'Amount') {
                        value = '<span style="color: #999;">-</span>';
                    } else {
                        value = '<span style="color: #999;">-</span>';
                    }
                } else if (typeof value === 'object') {
                    value = JSON.stringify(value);
                }
                
                // Format amounts with currency (negative for expenses, positive for income)
                if (h === 'Amount' && value && !String(value).includes('span')) {
                    const num = parseFloat(value);
                    if (!isNaN(num)) {
                        const absNum = Math.abs(num);
                        const sign = num >= 0 ? '+' : '-';
                        const color = num < 0 ? '#dc3545' : '#28a745';
                        value = `<span style="font-weight: bold; color: ${color};">${sign}$${absNum.toFixed(2)}</span>`;
                    }
                }
                
                // Standardize date formatting
                if (h === 'Transaction Date' && value && !String(value).includes('span')) {
                    value = standardizeDate(value);
                }
                
                // Style missing value indicators with proper formatting
                const valueStr = String(value);
                if (valueStr.includes('[Vendor Missing]') || valueStr === 'Vendor Missing') {
                    value = '<span style="color: #999; font-style: italic;">[Vendor Missing]</span>';
                } else if (valueStr.includes('[Category Missing]') || valueStr === 'Category Missing') {
                    value = '<span style="color: #999; font-style: italic;">[Category Missing]</span>';
                }
                
                table += `<td>${value}</td>`;
            });
            table += '</tr>';
        });

        table += '</tbody></table>';
        tableContainer.innerHTML = table;
        console.log('‚úÖ Table built and displayed successfully!');
        
        } catch (displayError) {
            console.error('‚ùå Error in displayResults:', displayError);
            console.error('‚ùå Display error stack:', displayError.stack);
            
            const tableContainer = document.getElementById('cleanedDataTable');
            tableContainer.innerHTML = `
                <div style="color: red; padding: 20px; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 5px;">
                    <h4>üêõ Display Error</h4>
                    <p><strong>Error:</strong> ${displayError.message}</p>
                    <pre style="font-size: 12px; overflow-x: auto;">${displayError.stack}</pre>
                </div>
            `;
        }
    }

    function standardizeDate(dateStr) {
        if (!dateStr || dateStr.trim() === '' || dateStr === '-') {
            return '<span style="color: #999;">-</span>';
        }
        
        try {
            // Handle various date formats
            let cleanDate = dateStr.toString().trim();
            
            // Convert different formats to ISO format
            if (cleanDate.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                // MM/DD/YYYY or M/D/YYYY
                const parts = cleanDate.split('/');
                cleanDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
            } else if (cleanDate.match(/^\d{1,2}-\d{1,2}-\d{4}$/)) {
                // MM-DD-YYYY or M-D-YYYY
                const parts = cleanDate.split('-');
                cleanDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
            } else if (cleanDate.match(/^\d{8}$/)) {
                // YYYYMMDD
                cleanDate = `${cleanDate.substr(0,4)}-${cleanDate.substr(4,2)}-${cleanDate.substr(6,2)}`;
            } else if (cleanDate.match(/^[A-Za-z]{3}\s+\d{1,2}\s+\d{4}$/)) {
                // "Oct 5 2023" format
                const date = new Date(cleanDate);
                if (!isNaN(date.getTime())) {
                    cleanDate = date.toISOString().split('T')[0];
                }
            }
            
            // Validate and format the final date
            const date = new Date(cleanDate + 'T00:00:00');
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0]; // Return YYYY-MM-DD format
            }
            
            return dateStr; // Return original if parsing fails
        } catch (e) {
            return dateStr; // Return original if any error
        }
    }

    function csvToJSON(csv) {
        const lines = csv.split('\n').filter(line => line.trim() !== '');
        const result = [];
        const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
        
        for (let i = 1; i < lines.length; i++) {
            const obj = {};
            // Better CSV parsing - handle quoted fields
            const currentline = parseCSVLine(lines[i]);
            
            for (let j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentline[j] ? currentline[j].trim().replace(/['"]/g, '') : '';
            }
            result.push(obj);
        }
        return result;
    }
    
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current); // Don't forget the last field
        return result;
    }
</script>

</body>
</html>
